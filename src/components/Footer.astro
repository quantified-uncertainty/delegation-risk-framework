---
import EditLink from 'virtual:starlight/components/EditLink';
import LastUpdated from 'virtual:starlight/components/LastUpdated';
import Pagination from 'virtual:starlight/components/Pagination';
import config from 'virtual:starlight/user-config';
import versionInfo from '../../version.json';

const pageTitle = Astro.props.entry?.data?.title || 'Untitled';
const pageUrl = Astro.url.href;

// Build version string: 1.0.3+abc1234
const version = `${versionInfo.major}.${versionInfo.minor}.${versionInfo.patch}${versionInfo.gitHash ? '+' + versionInfo.gitHash : ''}`;
---

<footer class="sl-flex">
	<div class="meta sl-flex">
		<EditLink />
		<LastUpdated />
	</div>

	<!-- Copy as Markdown Button -->
	<div class="copy-markdown-container">
		<button
			id="copy-markdown-btn"
			class="copy-markdown-btn"
			data-page-title={pageTitle}
			data-page-url={pageUrl}
		>
			<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
				<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
			</svg>
			Copy as Markdown
		</button>
		<span id="copy-status" class="copy-status"></span>
	</div>

	<Pagination />

	<div class="footer-info sl-flex">
		<span class="version">v{version}</span>
		{
			config.credits && (
				<a class="kudos sl-flex" href="https://starlight.astro.build">
					{Astro.locals.t('builtWithStarlight.label')}
				</a>
			)
		}
	</div>
</footer>

<style>
	footer {
		flex-direction: column;
		gap: 1.5rem;
	}
	.meta {
		gap: 0.75rem 3rem;
		justify-content: space-between;
		flex-wrap: wrap;
		margin-top: 3rem;
		font-size: var(--sl-text-sm);
		color: var(--sl-color-gray-3);
	}
	.meta > :global(p:only-child) {
		margin-inline-start: auto;
	}

	.footer-info {
		align-items: center;
		justify-content: center;
		gap: 1.5rem;
		margin: 1.5rem auto;
	}

	.version {
		font-size: var(--sl-text-xs);
		color: var(--sl-color-gray-4);
		font-family: var(--sl-font-mono);
	}

	.kudos {
		align-items: center;
		gap: 0.5em;
		font-size: var(--sl-text-xs);
		text-decoration: none;
		color: var(--sl-color-gray-3);
	}
	.kudos:hover {
		color: var(--sl-color-white);
	}

	/* Copy as Markdown Button Styles */
	.copy-markdown-container {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		padding: 1rem 0;
		border-top: 1px solid var(--sl-color-gray-5);
		border-bottom: 1px solid var(--sl-color-gray-5);
	}

	.copy-markdown-btn {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.5rem 0.875rem;
		background: var(--sl-color-gray-6);
		border: 1px solid var(--sl-color-gray-5);
		border-radius: 0.375rem;
		color: var(--sl-color-gray-2);
		font-size: var(--sl-text-sm);
		font-family: inherit;
		cursor: pointer;
		transition: all 0.15s ease;
	}

	.copy-markdown-btn:hover {
		background: var(--sl-color-gray-5);
		border-color: var(--sl-color-gray-4);
		color: var(--sl-color-white);
	}

	.copy-markdown-btn:active {
		background: var(--sl-color-accent-low);
		border-color: var(--sl-color-accent);
	}

	.copy-markdown-btn:disabled {
		opacity: 0.7;
		cursor: wait;
	}

	.copy-markdown-btn svg {
		width: 1rem;
		height: 1rem;
		flex-shrink: 0;
	}

	.copy-status {
		font-size: var(--sl-text-sm);
		color: var(--sl-color-green);
		opacity: 0;
		transition: opacity 0.2s ease;
	}

	.copy-status.visible {
		opacity: 1;
	}

	.copy-status.error {
		color: var(--sl-color-red);
	}
</style>

<script>
	(function() {
		const btn = document.getElementById('copy-markdown-btn');
		const status = document.getElementById('copy-status');

		if (!btn || !status) return;

		const originalHTML = btn.innerHTML;

		btn.addEventListener('click', async () => {
			try {
				btn.disabled = true;
				btn.innerHTML = `
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<circle cx="12" cy="12" r="10"></circle>
						<path d="M12 6v6l4 2"></path>
					</svg>
					Converting...
				`;

				// Dynamically load Turndown.js from CDN if not already loaded
				if (!window.TurndownService) {
					await loadScript('https://unpkg.com/turndown@7.1.2/dist/turndown.js');
				}

				// Get page content from the main content area
				const content = document.querySelector('main .sl-markdown-content') ||
				               document.querySelector('main [data-pagefind-body]') ||
				               document.querySelector('main article');

				if (!content) {
					throw new Error('Content not found');
				}

				// Clone content to avoid modifying the page
				const contentClone = content.cloneNode(true);

				// Remove any script tags, copy buttons, or other non-content elements
				contentClone.querySelectorAll('script, .copy-markdown-container, .expressive-code .copy').forEach(el => el.remove());

				// Configure Turndown for clean output
				const turndown = new TurndownService({
					headingStyle: 'atx',
					codeBlockStyle: 'fenced',
					bulletListMarker: '-',
					emDelimiter: '*',
				});

				// Keep fenced code blocks with language
				turndown.addRule('fencedCodeBlock', {
					filter: function(node) {
						return node.nodeName === 'PRE' && node.querySelector('code');
					},
					replacement: function(content, node) {
						const code = node.querySelector('code');
						const langClass = Array.from(code.classList).find(c => c.startsWith('language-'));
						const lang = langClass ? langClass.replace('language-', '') : '';
						const text = code.textContent || '';
						return '\n```' + lang + '\n' + text.trim() + '\n```\n';
					}
				});

				// Convert HTML to Markdown
				const markdown = turndown.turndown(contentClone);

				// Generate metadata header
				const title = btn.dataset.pageTitle || 'Untitled';
				const url = btn.dataset.pageUrl || window.location.href;
				const date = new Date().toISOString().split('T')[0];

				const fullContent = `---
title: "${title}"
source: ${url}
copied: ${date}
---

${markdown}`;

				// Copy to clipboard
				await navigator.clipboard.writeText(fullContent);

				// Show success feedback
				btn.innerHTML = `
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<polyline points="20 6 9 17 4 12"></polyline>
					</svg>
					Copied!
				`;
				status.textContent = 'Markdown copied to clipboard';
				status.classList.remove('error');
				status.classList.add('visible');

				setTimeout(() => {
					btn.innerHTML = originalHTML;
					btn.disabled = false;
					status.classList.remove('visible');
				}, 2000);

			} catch (err) {
				console.error('Copy failed:', err);
				btn.innerHTML = `
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<circle cx="12" cy="12" r="10"></circle>
						<line x1="15" y1="9" x2="9" y2="15"></line>
						<line x1="9" y1="9" x2="15" y2="15"></line>
					</svg>
					Failed
				`;
				status.textContent = err.message || 'Copy failed';
				status.classList.add('error');
				status.classList.add('visible');

				setTimeout(() => {
					btn.innerHTML = originalHTML;
					btn.disabled = false;
					status.classList.remove('visible');
					status.classList.remove('error');
				}, 3000);
			}
		});

		function loadScript(src) {
			return new Promise((resolve, reject) => {
				const script = document.createElement('script');
				script.src = src;
				script.onload = resolve;
				script.onerror = () => reject(new Error('Failed to load conversion library'));
				document.head.appendChild(script);
			});
		}
	})();
</script>
